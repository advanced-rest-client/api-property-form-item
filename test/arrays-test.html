<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>api-property-form-item test</title>

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

    <script type="module" src="../api-property-form-item.js"></script>
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <api-property-form-item></api-property-form-item>
      </template>
    </test-fixture>

    <script type="module">
    suite('Array model', () => {
      let element;
      let model;
      setup(function(done) {
        element = fixture('basic');
        model = {
          schema: {
            isArray: true,
            inputType: 'number',
            minimum: 2,
            maximum: 20
          }
        };
        element.model = model;
        flush(() => done());
      });

      test('isEnum is false', function() {
        assert.isFalse(element.isEnum);
      });

      test('isInput is false', function() {
        assert.isFalse(element.isInput);
      });

      test('isArray is true', function() {
        assert.isTrue(element.isArray);
      });

      test('isBoolean is false', function() {
        assert.isFalse(element.isBoolean);
      });

      test('arrayValue is computed', function() {
        assert.typeOf(element.arrayValue, 'array');
      });

      test('Dropdowns are not rendered', function() {
        const node = element.shadowRoot.querySelector('paper-dropdown-menu');
        assert.notOk(node);
      });

      test('<label> for array values is rendered', function() {
        const node = element.shadowRoot.querySelector('label');
        assert.ok(node);
      });

      test('Has no inputs', function() {
        const nodes = element.shadowRoot.querySelectorAll('paper-input');
        assert.lengthOf(nodes, 0);
      });

      test('Will not pass validation for invalid value', function(done) {
        element.addEmptyArrayValue();
        element.set('arrayValue.0.value', 1);
        flush(() => {
          assert.isFalse(element.validate());
          done();
        });
      });

      test('Will pass validation for valid value', function(done) {
        element.addEmptyArrayValue();
        element.set('arrayValue.0.value', 2);
        flush(() => {
          assert.isTrue(element.validate());
          done();
        });
      });

      test('Adds action button adds new input', (done) => {
        const node = element.shadowRoot.querySelector('.add-action paper-button');
        node.click();
        flush(() => {
          const nodes = element.shadowRoot.querySelectorAll('.array-item');
          assert.lengthOf(nodes, 1);
          done();
        });
      });

      test('Sets value from array input', (done) => {
        element.addEmptyArrayValue();
        flush(() => {
          const node = element.shadowRoot.querySelector('.array-item paper-input');
          node.value = 'test';
          node.dispatchEvent(new CustomEvent('input'));
          assert.lengthOf(element.value, 1);
          assert.equal(element.value[0], 'test');
          done();
        });
      });

      test('Removes value when button click', (done) => {
        element.addEmptyArrayValue();
        element.addEmptyArrayValue();
        flush(() => {
          const node = element.shadowRoot.querySelector('.array-item paper-icon-button');
          node.click();
          flush(() => {
            const nodes = element.shadowRoot.querySelectorAll('.array-item');
            assert.lengthOf(nodes, 1);
            done();
          });
        });
      });
    });
    </script>
  </body>
</html>
